# 更新日志

本文档记录了 Gemini API 智能冷却负载均衡代理服务的所有重要变更。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [未发布]

### 计划中
- 支持更多 Gemini 模型
- 添加请求缓存功能
- 实现更细粒度的速率限制
- 支持 WebSocket 连接

---

## [2.1.0] - 2025-01-21

### 新增
- 🧠 **智能冷却机制**: 区分永久失效和临时限流，自动冷却恢复
- ❄️ **分级冷却策略**: 
  - 429/503 错误 → 24小时冷却
  - 502/504 错误 → 5分钟冷却
  - 其他 5xx 错误 → 10分钟冷却
- 🔄 **自动恢复**: 冷却期满后自动恢复 key 使用
- 📊 **增强状态监控**: 显示详细的冷却信息和剩余时间
- 🧹 **自动清理**: 每分钟清理过期的冷却状态
- 🚨 **紧急模式**: 所有 key 失效时重置状态

### 改进
- ⚡ **性能优化**: 减少内存分配，开销 < 0.01%
- 🎯 **智能选择**: 优先使用冷却时间最短的 key
- 📈 **详细统计**: 提供更全面的服务状态信息
- 🔍 **错误分类**: 更精确的错误类型识别和处理

### 修复
- 修复了 key 状态管理的竞态条件
- 解决了冷却时间计算不准确的问题
- 修复了状态清理时的内存泄漏

---

## [2.0.0] - 2025-01-15

### 新增
- 🔄 **负载均衡**: 支持多个 Gemini API key 的智能分配
- 🛡️ **认证层**: 前端使用认证 token，后端使用真实 API key 池
- ⚙️ **负载均衡策略**: 
  - Round-robin（轮询）
  - Random（随机）
- 🏥 **健康检查**: `/v1/status` 端点提供详细状态信息
- 🔁 **智能重试**: 自动检测失效 key 并切换到可用 key
- 📊 **统计信息**: 实时监控 key 使用情况和成功率

### 改进
- 🚀 **高可用性**: 单个 key 失效不影响整体服务
- 🔒 **安全增强**: API key 不暴露给前端
- 📈 **可扩展性**: 支持动态添加/移除 API keys
- 🎯 **容错能力**: 智能故障转移和错误处理

### 破坏性变更
- 需要配置 `VALID_AUTH_TOKENS` 环境变量
- 前端需要使用认证 token 而非直接使用 API key
- 状态检查端点从 `/status` 改为 `/v1/status`

---

## [1.2.0] - 2025-01-10

### 新增
- 📝 **嵌入向量支持**: 添加 `/v1/embeddings` 端点
- 🌊 **流式响应优化**: 改进 SSE 数据处理
- 📋 **模型列表**: 添加 `/v1/models` 端点

### 改进
- ⚡ **响应速度**: 优化请求处理流程
- 🔧 **错误处理**: 更详细的错误信息和状态码
- 📊 **内容类型支持**: 支持图片和音频输入

### 修复
- 修复了流式响应中的数据丢失问题
- 解决了特殊字符编码问题
- 修复了 CORS 头设置不完整的问题

---

## [1.1.0] - 2025-01-05

### 新增
- 🌐 **CORS 支持**: 完整的跨域资源共享配置
- 🔄 **请求重试**: 网络错误时的自动重试机制
- 📝 **请求验证**: 更严格的输入参数验证

### 改进
- 🎨 **代码结构**: 重构代码以提高可维护性
- 📚 **文档完善**: 添加详细的 API 文档
- 🧪 **测试覆盖**: 增加单元测试和集成测试

### 修复
- 修复了某些边缘情况下的内存泄漏
- 解决了长时间运行时的性能下降问题

---

## [1.0.0] - 2025-01-01

### 新增
- 🎉 **首次发布**: Gemini API 代理服务基础版本
- 💬 **聊天完成**: 支持 `/v1/chat/completions` 端点
- 🌊 **流式响应**: 支持实时流式数据传输
- 🔒 **基础认证**: API key 验证机制
- 📱 **多模态支持**: 支持文本、图片和音频输入
- 🛡️ **安全设置**: 配置安全过滤器
- ⚙️ **参数映射**: OpenAI 格式到 Gemini 格式的参数转换

### 支持的功能
- 文本生成和对话
- 流式和非流式响应
- 多种内容类型（文本、图片、音频）
- 温度、top_p 等生成参数控制
- 停止序列和最大 token 限制
- JSON 响应格式

---

## 版本说明

### 版本号规则

本项目遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范：

- **主版本号 (MAJOR)**: 不兼容的 API 变更
- **次版本号 (MINOR)**: 向后兼容的功能新增
- **修订号 (PATCH)**: 向后兼容的问题修正

### 发布周期

- **主版本**: 根据需要发布，通常包含重大架构变更
- **次版本**: 每月发布，包含新功能和改进
- **修订版**: 根据需要发布，主要修复 bug 和安全问题

### 支持政策

- **当前版本**: 完全支持，包含新功能开发和 bug 修复
- **前一个主版本**: 安全更新和关键 bug 修复
- **更早版本**: 仅提供安全更新

---

## 迁移指南

### 从 v1.x 升级到 v2.0

1. **环境变量更新**:
   ```bash
   # 新增必需的环境变量
   wrangler secret put VALID_AUTH_TOKENS --env production
   
   # API keys 现在支持多个（逗号分隔）
   wrangler secret put GEMINI_API_KEYS --env production
   ```

2. **前端代码更新**:
   ```javascript
   // 旧版本
   headers: {
     'x-goog-api-key': 'your-gemini-api-key'
   }
   
   // 新版本
   headers: {
     'Authorization': 'Bearer your-auth-token'
   }
   ```

3. **状态检查端点**:
   ```javascript
   // 旧版本
   fetch('/status')
   
   // 新版本
   fetch('/v1/status')
   ```

### 从 v2.0 升级到 v2.1

无需代码更改，智能冷却功能自动启用。建议：

1. **监控冷却状态**:
   ```javascript
   const status = await fetch('/v1/status').then(r => r.json());
   console.log('冷却详情:', status.keyPool.coolingDetails);
   ```

2. **增加 API keys**（可选）:
   ```bash
   # 为了更好的可用性，建议配置更多 keys
   wrangler secret put GEMINI_API_KEYS --env production
   ```

---

## 贡献者

感谢所有为这个项目做出贡献的开发者：

- [@Pizone-ai](https://github.com/Pizone-ai) - 项目创建者和主要维护者

---

## 许可证

本项目采用 [MIT 许可证](LICENSE)。

---

**注意**: 本更新日志遵循 [Keep a Changelog](https://keepachangelog.com/) 格式。如果您发现任何遗漏或错误，请提交 Issue 或 Pull Request。